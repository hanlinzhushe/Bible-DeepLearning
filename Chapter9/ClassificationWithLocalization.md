图像分类问题：Image Classification，判断图像是不是汽车  
图像定位分类问题：Image Classification With Localization，判断图像是不是一辆汽车，并标出洗车的位置  
物体检测问题：检测图像中是否存在车子。如果有车子，标出洗车的位置。如果有多个车子，标出每个车子的位置。  

# 利用神经网络进行图像定位

![](/assets/images/Chapter9/19.png)  

假设要识别的目标有三类：pedestrain、car、motorcycle  
定义图像的左上角坐标为（0，0），右下角坐标为（1，1）。目标的中心点为bx, by，目标的大小为bh, bw。  
定义一个训练集的label应该为1*8的向量，即：  
$$
y = [p_c, b_x, b_y, b_h, b_w, c_1, c_2, c_3]^\top
$$

pc：图像中是否存在对象。  
bx, by, bw, bh：对象的位置。  
c1, c2, c3：是什么对象，三个数值只能有一个是1。  
例如：$y = [1, b_x, b_y, b_h, b_w, 0, 1, 0]^\top$或$y = [0, ?, ?, ?, ?, ?, ?, ?]^\top$  

定义一个样本上的损失函数为：  
当pc = 1时，l = MSE(bx, by, bw, bh) + CrossEntropy(c1, c2, c3)  
当pc = 0时，l = 1  

# 目标检测算法  

1. 使用图像分类算法判断一张图像是不是车  
2. 滑动窗口目标检测  
    以固定的步幅滑动窗口，遍历图像每个区域。  
    把这些剪裁后的小图像输入卷积网络。  
    对每个位置按0、1进行分类。  
3. 换一个更大的窗口，重复以上动作。  

缺点：计算成本高  

# 在卷积层上使用滑动窗口算法  

1. 把事FC的网络转成全部是卷积层的网络。例如：  
![](/assets/images/Chapter9/20.png)   
2. 在卷积层上使用滑动窗口  
![](/assets/images/Chapter9/21.png)   

原理：  
不需要把输入图像分割成4个子集分别执行前向传播，而是把它们作为一张图像输入给卷积层进行计算。  
其中的公有区域可以共享很多计算。  

缺点：  
边界框的位置可能不够准确。  

# YOLO算法  You Only Look Once  

![](/assets/images/Chapter9/22.png)   
把一个图像切成3 * 3（或更多，19 * 19）个格子。  
对每个格式做上文提到的图像分类定位算法。  
每个格子输出的是1 * 8的向量，整体输出是3 * 3 * 8的张量。  

Notices：  
1. 这个算法与图像分类定位算法非常像。  
2. 可以显式地输出边界框坐标，边界框可以具有任意的宽高比，且输出坐标更精确。  
3. 算法通过卷积实现，而不是单纯地把算法执行9次。  
4. 卷积实现 =》 速度非常快，可以达到实时。  

## 如何编码bx, by, bw, bh？  

每个小格子的坐标都是左上角（0，0）右下角（1，1）。  
格子内的坐标都是相对格子左上角（0，0）的。  
bx， by的范围是[0, 1]，bw, bh有可能大于1。  
以上是比较常规的参数形式。YOLO原文有更复杂、效果更好的参数方法。  
这篇论文比较难。  

# 对象检测算法的评价 - 交并比

IoU --- Intersection over Union  
= (检测区域 交 真实区域) / (检测区域 并 真实区域)  
correct if IoU >= 0.5。  


# 非最大值抑制 Non-max suppression

用于保证每个对象只被检测一次。  
![](/assets/images/Chapter9/23.png)   
例如这种情况，多个格子都检测到了目标。

1. 把所有p_c <= 0.6的box扔掉。  
2. 找到剩下的报告中，p_c最高的box，把这个box作为输出。  
3. 其它box如果与这个box重叠，则按照IoU降低它的p_c。若降至0.5以下，则把box扔掉。  
4. 如果还有剩下的box， go to 2.  

如果检测对象分多个类别，分别对每个类别做非最大值抑制。  

# Anchor Boxes

![](/assets/images/Chapter9/24.png)   
如果两个不同对象的中心点落在同一个格子中。怎样才能把两个对象都表示到y中？  
（实际上这种case不常见）。   

1. 预先定义两个不同形状的anchor box  
![](/assets/images/Chapter9/25.png)   
2. 对两种对象的检测会生成两个label，每个label都是1*8的向量（根据上文定义）。每个label关联一个anchor box。  
3. 把两个label合并成一个大的label，大小为1 * 16.  
4. 后面没看懂？  

实际上两个对象中心点落在同一个格子的case不常见。  
anchor box更多的是另一种作用：针对对象有明显特征的情况可以有针对性地识别。    

## 怎样选择anchor box?  
1. 手工设计， 5-10个  
2. K-Means算法对形态进行聚类。  

# 候选区域算法 region proposal

## R-CNN 
带区域的卷积网络，regions with CNN

1. 使用图像分割算法，分割出色块  
2. 基于色块运行卷积网络的分类定位算法  

## Fast R-CNN  

改进：用卷积实现滑动窗口  

## Faster R-CNN

改进：使用卷积网络来推荐候选区域  